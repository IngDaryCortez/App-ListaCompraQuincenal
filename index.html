<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Compra PALI Quincenal</title>
    <!-- Icono de Pesta√±a (Un carrito de compras) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõí</text></svg>">
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter */
        body { font-family: 'Inter', sans-serif; }
        /* Estilos personalizados para el contenedor principal */
        .container-app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f7f7f7;
        }
        /* Estilo para la tabla de la lista de compra */
        .grid-list-item {
            display: grid;
            grid-template-columns: 1fr 100px 120px 60px; /* Nombre, Cantidad, Precio Final, Check */
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s;
        }
        .grid-list-item:last-child {
            border-bottom: none;
        }
        .grid-list-item.checked {
            background-color: #ecfdf5; /* Verde muy claro para productos comprados */
        }
        /* Estilo para el input de precio final */
        .final-price-input {
            width: 100%;
            padding: 0.3rem;
            border: 1px solid #ccc;
            border-radius: 0.375rem;
            text-align: right;
            transition: background-color 0.15s;
        }
        .final-price-input:disabled {
            background-color: #e5e7eb; /* Gris claro para indicar que est√° deshabilitado */
            color: #4b5563; /* Texto m√°s oscuro */
            cursor: not-allowed;
            border: 1px solid transparent; /* Hacer que parezca un texto, no un input editable */
        }
        /* Estilos para el modal de Firebase */
        #firebase-modal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Contenedor Principal de la Aplicaci√≥n -->
    <div id="app" class="container-app p-4 md:p-8">

        <!-- Encabezado de la Aplicaci√≥n -->
        <header class="bg-indigo-600 shadow-xl p-4 md:p-6 rounded-xl mb-6 text-white flex justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-bold">üõí Control de Compra PALI</h1>
            <div class="text-sm">
                <p id="auth-status" class="font-semibold"></p>
                <p id="user-id-display" class="truncate max-w-[150px] md:max-w-full text-xs opacity-80">ID: Cargando...</p>
            </div>
        </header>

        <!-- Controles de Navegaci√≥n y Generaci√≥n -->
        <section class="bg-white shadow-lg rounded-xl p-4 mb-6">
            <h2 class="text-xl font-semibold mb-3 text-indigo-700">Selecci√≥n y Acciones</h2>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Selector de Mes -->
                <div class="col-span-2 md:col-span-1">
                    <label for="month-selector" class="block text-sm font-medium text-gray-700 mb-1">Mes de Compra</label>
                    <select id="month-selector" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        <!-- Opciones se cargar√°n con JS -->
                    </select>
                </div>
                <!-- Selector de Quincena -->
                <div class="col-span-2 md:col-span-1">
                    <label for="quincena-selector" class="block text-sm font-medium text-gray-700 mb-1">Quincena</label>
                    <select id="quincena-selector" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        <option value="quincena1">Quincena 1</option>
                        <option value="quincena2">Quincena 2</option>
                    </select>
                </div>

                <!-- Bot√≥n Generar Pr√≥ximo Mes -->
                <button id="btn-generate-next-month" class="col-span-2 lg:col-span-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 transform hover:scale-[1.02] disabled:opacity-50" disabled>
                    Generar Pr√≥ximo Mes
                </button>

                <!-- Bot√≥n Eliminar Lista del Mes -->
                <button id="btn-delete-month" class="col-span-2 lg:col-span-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 transform hover:scale-[1.02] disabled:opacity-50" disabled>
                    Eliminar Lista del Mes
                </button>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-200 grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Bot√≥n Generar Lista Inicial (Solo visible si no hay listas) -->
                <button id="btn-initial-list" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 transform hover:scale-[1.02] hidden">
                    Generar Lista Inicial (Nov 2025)
                </button>
                
                <!-- Bot√≥n Guardar Compra (Cerrar Quincena) -->
                <button id="btn-close-quincena" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 transform hover:scale-[1.02] disabled:opacity-50" disabled>
                    Guardar y Cerrar Compra (Quincena)
                </button>
            </div>
        </section>

        <!-- Listas de Compra (Grid Desplegable) -->
        <section class="bg-white shadow-lg rounded-xl p-4 mb-6 flex-1">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-semibold text-indigo-700">Lista de Compra</h2>
                <button id="btn-open-catalog" class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-medium py-1.5 px-3 rounded-lg shadow-sm transition duration-150 transform hover:scale-[1.03]">
                    Gesti√≥n de Cat√°logo
                </button>
            </div>

            <!-- Encabezados del Grid -->
            <div class="grid-list-item font-bold text-gray-600 text-sm bg-gray-100 rounded-t-lg">
                <span class="truncate">Producto</span>
                <span class="text-center">Cant.</span>
                <span class="text-right">Precio Final (C$)</span>
                <span class="text-center">Comprado</span>
            </div>

            <!-- Contenedor de la Lista (Se llena con JS) -->
            <div id="shopping-list-container" class="space-y-1">
                <p class="text-gray-500 text-center py-4" id="loading-message">Cargando lista...</p>
            </div>
        </section>

        <!-- Informes y Resumen -->
        <section class="bg-white shadow-lg rounded-xl p-4 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-indigo-700">Informes de Costos y Precios</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                <!-- Resumen de Costos Mensuales -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <h3 class="font-bold text-lg text-blue-700 mb-2">Costo Mensual Total (Quincena 1 + 2)</h3>
                    <p class="text-2xl font-extrabold text-blue-900" id="total-cost-display">0.00 C$</p>
                    <p class="text-sm text-gray-600 mt-2" id="cost-comparison"></p>
                </div>

                <!-- Reporte de Variaci√≥n de Precios -->
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <h3 class="font-bold text-lg text-yellow-700 mb-2">Variaci√≥n de Precios (vs. Mes Anterior)</h3>
                    <div id="price-change-report" class="space-y-1 text-sm max-h-40 overflow-y-auto">
                        <p class="text-gray-500">No hay datos de meses anteriores para comparar.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Modal para Gesti√≥n de Cat√°logo y Carga de CSV -->
        <div id="catalog-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 relative">
                <button id="btn-close-catalog" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
                <h2 class="text-2xl font-bold text-indigo-700 mb-4">Gesti√≥n de Cat√°logo de Productos</h2>

                <!-- Formulario para Agregar/Editar Producto -->
                <div class="bg-gray-100 p-4 rounded-lg mb-4 border border-gray-200">
                    <h3 class="text-lg font-semibold mb-3">Agregar/Editar Producto</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <input type="hidden" id="catalog-product-id">
                        <input type="text" id="catalog-product-name" placeholder="Nombre" class="col-span-2 p-2 border rounded-lg" required>
                        <input type="number" id="catalog-product-price" placeholder="Precio Base (C$)" class="p-2 border rounded-lg text-right" min="0" step="0.01" required>
                        <input type="text" id="catalog-product-unit" placeholder="Unidad (lb, un)" class="p-2 border rounded-lg" required>
                    </div>
                    <div class="mt-3 flex justify-end space-x-2">
                        <button id="btn-clear-catalog-form" class="bg-gray-400 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-lg transition">Limpiar</button>
                        <button id="btn-save-catalog-product" class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg transition">Guardar Producto</button>
                    </div>
                </div>

                <!-- Carga de CSV -->
                <div class="bg-indigo-50 p-4 rounded-lg mb-4 border border-indigo-200">
                    <h3 class="text-lg font-semibold mb-3">Carga Masiva (CSV)</h3>
                    <p class="text-sm text-gray-600 mb-2">Formato requerido: `Nombre,Precio Base,Unidad` (una l√≠nea por producto).</p>
                    <input type="file" id="csv-file-input" accept=".csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200">
                    <button id="btn-upload-csv" class="mt-3 bg-teal-500 hover:bg-teal-600 text-white font-medium py-2 px-4 rounded-lg transition disabled:opacity-50" disabled>
                        Subir y Actualizar Cat√°logo
                    </button>
                    <div id="csv-feedback" class="mt-2 text-sm"></div>
                </div>

                <!-- Lista de Cat√°logo Actual -->
                <h3 class="text-lg font-semibold mt-6 mb-3">Cat√°logo Actual (Editable)</h3>
                <div id="catalog-list" class="max-h-60 overflow-y-auto space-y-2">
                    <!-- Productos del cat√°logo se cargar√°n aqu√≠ -->
                </div>
            </div>
        </div>

        <!-- Notificaci√≥n de Di√°logo/Alerta Personalizada -->
        <div id="custom-alert" class="fixed bottom-4 right-4 bg-gray-800 text-white p-4 rounded-lg shadow-xl z-[60] opacity-0 transition-opacity duration-300 pointer-events-none" style="min-width: 250px;">
            <p id="alert-message"></p>
        </div>

    </div>

    <!-- Scripts de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuraci√≥n e Inicializaci√≥n de Firebase ---
       const firebaseConfig = {
        apiKey: "AIzaSyBYpzpEwnHLKTBJrPessNqwgGF9-2S1BXo",
        authDomain: "app-listacompraquincenal.firebaseapp.com",
        projectId: "app-listacompraquincenal",
        storageBucket: "app-listacompraquincenal.firebasestorage.app",
        messagingSenderId: "178599255890",
        appId: "1:178599255890:web:1f7934ab9c5ba6019be48b",
        measurementId: "G-CVCNG2DKQV"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Estructuras de datos principales
        let productCatalog = []; // Cat√°logo maestro de productos
        let monthlyLists = {}; // Listas de compra por mes (YYYY-MM: {quincena1: {items: [], isClosed: false}, quincena2: ...})

        // Estado de la aplicaci√≥n
        let currentMonthKey = ''; // YYYY-MM
        let currentQuincena = 'quincena1';

        // --- Elementos del DOM ---
        const $monthSelector = document.getElementById('month-selector');
        const $quincenaSelector = document.getElementById('quincena-selector');
        const $shoppingListContainer = document.getElementById('shopping-list-container');
        const $loadingMessage = document.getElementById('loading-message');
        const $catalogModal = document.getElementById('catalog-modal');
        const $catalogList = document.getElementById('catalog-list');
        const $btnGenerateNextMonth = document.getElementById('btn-generate-next-month');
        const $btnDeleteMonth = document.getElementById('btn-delete-month');
        const $btnInitialList = document.getElementById('btn-initial-list'); // Nuevo bot√≥n
        const $btnCloseQuincena = document.getElementById('btn-close-quincena'); // Nuevo bot√≥n
        const $totalCostDisplay = document.getElementById('total-cost-display');
        const $costComparison = document.getElementById('cost-comparison');
        const $priceChangeReport = document.getElementById('price-change-report');
        const $csvFileInput = document.getElementById('csv-file-input');
        const $btnUploadCsv = document.getElementById('btn-upload-csv');
        const $csvFeedback = document.getElementById('csv-feedback');
        const $authStatus = document.getElementById('auth-status');
        const $userIdDisplay = document.getElementById('user-id-display');

        // --- Funciones de Utility ---

        function showCustomAlert(message, type = 'info') {
            const $alert = document.getElementById('custom-alert');
            const $alertMessage = document.getElementById('alert-message');
            
            // Colores basados en tipo
            let bgColor = 'bg-gray-800';
            if (type === 'success') bgColor = 'bg-green-600';
            if (type === 'error') bgColor = 'bg-red-600';
            if (type === 'warning') bgColor = 'bg-yellow-600';

            $alert.className = `fixed bottom-4 right-4 ${bgColor} text-white p-4 rounded-lg shadow-xl z-[60] opacity-0 transition-opacity duration-300 pointer-events-none`;
            $alertMessage.textContent = message;
            
            // Mostrar y luego ocultar
            setTimeout(() => {
                $alert.classList.remove('opacity-0', 'pointer-events-none');
            }, 50);

            setTimeout(() => {
                $alert.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        }

        function getMonthName(date) {
            return date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
        }

        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${year}-${month}`;
        }

        // --- FIREBASE: Rutas de Datos ---
        const getCatalogPath = () => doc(db, `artifacts/${appId}/users/${userId}/configs/catalog_master`);
        const getMonthlyListCollection = () => collection(db, `artifacts/${appId}/users/${userId}/monthly_lists`);
        const getMonthlyListDoc = (monthKey) => doc(db, `artifacts/${appId}/users/${userId}/monthly_lists/${monthKey}`);


        // --- FIREBASE: L√≥gica de Cat√°logo ---

        async function saveCatalog() {
            if (!userId) return;
            try {
                await setDoc(getCatalogPath(), { products: productCatalog }, { merge: true });
                showCustomAlert('Cat√°logo guardado con √©xito.', 'success');
            } catch (e) {
                console.error("Error saving catalog:", e);
                showCustomAlert('Error al guardar el cat√°logo.', 'error');
            }
        }

        function setupCatalogListener() {
            if (!userId) return;
            onSnapshot(getCatalogPath(), (docSnap) => {
                if (docSnap.exists()) {
                    productCatalog = docSnap.data().products || [];
                    // Si el cat√°logo est√° vac√≠o, inicializar con los productos base.
                    if (productCatalog.length === 0) {
                        initializeCatalog();
                    }
                } else {
                    productCatalog = [];
                    initializeCatalog(); 
                }
                renderCatalog();
            }, (error) => {
                console.error("Error listening to catalog:", error);
            });
        }

        function initializeCatalog() {
            if (productCatalog.length > 0) return;

            const initialProducts = [
                'Cubos maguie', 'Empanizador', 'Sal', 'Az√∫car', 'Aceite', 'Lizano', 'Maseca', 'Arroz', 'Pollo',
                'carne molida', 'Pamper talla M2', 'toalla humeda', 'Leche', 'Pinolillo', 'Ace suli',
                'botella de cloro', 'Asistin', 'Tang', 'Margarina', 'Yogurt', 'Galletas', 'Gel de cabello',
                'Caf√©', 'Jalea peque√±a', 'Cebolla', 'Chiltoma', 'Tomate', 'Bananos', 'Bolsa para hielo', 'Pl√°tanos'
            ];
            
            productCatalog = initialProducts.map(name => ({
                id: crypto.randomUUID(),
                name: name,
                unitPrice: '25.00', // Precio base por defecto (el usuario debe ajustarlo)
                unit: 'unidades',
                initialQuantity: 1
            }));
            
            saveCatalog();
        }

        // --- FIREBASE: L√≥gica de Listas Mensuales ---

        async function saveMonthlyList() {
            if (!userId || !currentMonthKey) return;

            const listData = monthlyLists[currentMonthKey];
            if (!listData) return;

            // Recalcular costo total (solo de quincenas cerradas)
            // NOTA: El c√°lculo de costos ahora usa 'finalPrice' S√ìLO si la quincena est√° cerrada.
            // Aunque el input de precio no es editable, el precio final est√° inicializado con initialPrice
            // en 'generateInitialList'. Para que el informe sea √∫til, asumimos que 'finalPrice' se fija
            // en la quincena2 del mes anterior y se hereda como 'initialPrice' en el nuevo mes.
            
            const cost1 = listData.quincena1.isClosed ? listData.quincena1.items.reduce((sum, p) => sum + (p.checked ? parseFloat(p.finalPrice) || 0 : 0), 0) : 0;
            const cost2 = listData.quincena2.isClosed ? listData.quincena2.items.reduce((sum, p) => sum + (p.checked ? parseFloat(p.finalPrice) || 0 : 0), 0) : 0;
            
            listData.totalMonthlyCost = (cost1 + cost2).toFixed(2);

            try {
                await setDoc(getMonthlyListDoc(currentMonthKey), listData, { merge: true });
                renderTotalCost();
            } catch (e) {
                console.error("Error saving monthly list:", e);
                showCustomAlert('Error al guardar la lista de compra.', 'error');
            }
        }

        function setupMonthlyListsListener() {
            if (!userId) return;
            
            onSnapshot(getMonthlyListCollection(), (querySnapshot) => {
                monthlyLists = {};
                querySnapshot.forEach((doc) => {
                    monthlyLists[doc.id] = doc.data();
                });
                
                updateMonthSelector();
                
                // Si no hay listas, forzar la visualizaci√≥n del bot√≥n de inicio.
                if (Object.keys(monthlyLists).length === 0) {
                    $btnInitialList.classList.remove('hidden');
                    $btnGenerateNextMonth.disabled = true;
                    $btnCloseQuincena.disabled = true;
                    $btnDeleteMonth.disabled = true;
                    $loadingMessage.textContent = 'Presione "Generar Lista Inicial (Nov 2025)" para empezar.';
                } else {
                    $btnInitialList.classList.add('hidden');
                    
                    // Si el mes actual no est√° en la lista, establecer el m√°s reciente.
                    if (!monthlyLists[currentMonthKey] || !currentMonthKey) {
                        const sortedKeys = Object.keys(monthlyLists).sort().reverse();
                        currentMonthKey = sortedKeys[0] || '';
                        if (currentMonthKey) $monthSelector.value = currentMonthKey;
                    }
                    
                    // Asegurar que quincena1 y quincena2 existen con la nueva estructura
                    const currentMonthData = monthlyLists[currentMonthKey];
                    if(currentMonthData) {
                        // Migraci√≥n de datos antiguos si es necesario
                        if (!currentMonthData.quincena1.items) currentMonthData.quincena1 = { items: currentMonthData.quincena1, isClosed: false };
                        if (!currentMonthData.quincena2.items) currentMonthData.quincena2 = { items: currentMonthData.quincena2, isClosed: false };
                    }

                    renderShoppingList();
                    renderPriceChangeReport();
                    renderTotalCost();
                }

                $loadingMessage.classList.add('hidden');
                // Habilitar botones de acci√≥n si hay listas
                $btnGenerateNextMonth.disabled = Object.keys(monthlyLists).length === 0;
                $btnDeleteMonth.disabled = Object.keys(monthlyLists).length === 0;

            }, (error) => {
                console.error("Error listening to monthly lists:", error);
                showCustomAlert('Error al cargar las listas mensuales.', 'error');
            });
        }

        async function deleteCurrentMonthList() {
            if (!currentMonthKey || !confirm(`¬øEst√° seguro de eliminar la lista de ${monthlyLists[currentMonthKey].month}? Esta acci√≥n es irreversible.`)) {
                return;
            }

            try {
                await deleteDoc(getMonthlyListDoc(currentMonthKey));
                currentMonthKey = '';
                showCustomAlert(`Lista de compra eliminada.`, 'success');
            } catch (e) {
                console.error("Error deleting monthly list:", e);
                showCustomAlert('Error al eliminar la lista mensual.', 'error');
            }
        }

        /**
         * Crea una lista inicial para un mes.
         * @param {Date} date - La fecha para la cual se crear√° la lista.
         * @param {Array} baseCatalog - La lista base de productos para copiar (del cat√°logo o quincena anterior).
         */
        async function generateInitialList(date, baseCatalog = productCatalog) {
            const monthKey = formatDateKey(date);
            const monthName = getMonthName(date);

            if (monthlyLists[monthKey]) {
                showCustomAlert(`La lista de ${monthName} ya existe.`, 'warning');
                currentMonthKey = monthKey;
                return;
            }

            // Mapear productos a la estructura de la lista de compra
            const baseProducts = baseCatalog.map(p => ({
                id: crypto.randomUUID(),
                name: p.name,
                // Si viene del cat√°logo, usa unitPrice. Si viene de una quincena anterior, usa finalPrice.
                initialPrice: parseFloat(p.unitPrice || p.finalPrice) || 0,
                finalPrice: parseFloat(p.unitPrice || p.finalPrice) || 0, // Por defecto, el final es igual al inicial
                quantity: parseFloat(p.initialQuantity || p.quantity) || 1,
                unit: p.unit || 'unidades',
                checked: false
            }));

            // La Quincena 2 es una copia id√©ntica de la Quincena 1 al inicio del mes
            const quincena1Items = baseProducts.map(p => ({...p, id: crypto.randomUUID()}));
            const quincena2Items = baseProducts.map(p => ({...p, id: crypto.randomUUID()}));

            const newListData = {
                month: monthName,
                quincena1: { items: quincena1Items, isClosed: false }, // Nueva estructura con flag de cierre
                quincena2: { items: quincena2Items, isClosed: false }, // Nueva estructura con flag de cierre
                totalMonthlyCost: '0.00'
            };

            monthlyLists[monthKey] = newListData;
            currentMonthKey = monthKey;
            
            await saveMonthlyList();
            $monthSelector.value = monthKey;
            showCustomAlert(`Lista de ${monthName} generada con √©xito.`, 'success');
        }

        async function closeQuincenaList() {
            if (!currentMonthKey || !monthlyLists[currentMonthKey]) return;

            const quincenaData = monthlyLists[currentMonthKey][currentQuincena];

            if (quincenaData.isClosed) {
                showCustomAlert('Esta quincena ya est√° cerrada.', 'warning');
                return;
            }

            if (!confirm(`¬øEst√° seguro de CERRAR la ${currentQuincena} de ${monthlyLists[currentMonthKey].month}? Los precios y checks no se podr√°n modificar m√°s.`)) {
                return;
            }

            quincenaData.isClosed = true;
            await saveMonthlyList();
            renderShoppingList();
            showCustomAlert(`¬°Compra de ${currentQuincena} cerrada y guardada!`, 'success');
        }


        // --- UI RENDERIZADO y HANDLERS ---

        function updateMonthSelector() {
            const sortedKeys = Object.keys(monthlyLists).sort().reverse();
            $monthSelector.innerHTML = '';
            
            if (sortedKeys.length === 0) return;

            // Asegurar que currentMonthKey sea uno v√°lido si la lista ha cambiado
            if (!currentMonthKey || !monthlyLists[currentMonthKey]) {
                currentMonthKey = sortedKeys[0];
            }

            sortedKeys.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = monthlyLists[key].month;
                $monthSelector.appendChild(option);
            });

            if (currentMonthKey) {
                $monthSelector.value = currentMonthKey;
            }
        }

        function renderShoppingList() {
            $shoppingListContainer.innerHTML = '';

            if (!currentMonthKey || !monthlyLists[currentMonthKey]) {
                $shoppingListContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Seleccione un mes o use el bot√≥n inicial.</p>';
                return;
            }

            const currentQuincenaData = monthlyLists[currentMonthKey][currentQuincena];
            const currentList = currentQuincenaData.items;
            const isClosed = currentQuincenaData.isClosed;

            $btnCloseQuincena.disabled = isClosed;
            $btnCloseQuincena.textContent = isClosed ? `COMPRA CERRADA (${currentQuincena.toUpperCase()})` : 'Guardar y Cerrar Compra (Quincena)';
            $btnCloseQuincena.classList.toggle('bg-gray-500', isClosed);
            $btnCloseQuincena.classList.toggle('hover:bg-red-800', !isClosed);
            
            // Si la lista est√° cerrada, el bot√≥n de generar el pr√≥ximo mes debe revisar la Q2
            const nextMonthDisabled = currentQuincena === 'quincena1' || !monthlyLists[currentMonthKey].quincena2.isClosed;
            $btnGenerateNextMonth.disabled = nextMonthDisabled;


            if (!currentList || currentList.length === 0) {
                $shoppingListContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No hay productos en esta quincena.</p>';
                return;
            }

            currentList.forEach(product => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `grid-list-item hover:bg-gray-50 ${product.checked ? 'checked' : ''}`; 
                itemDiv.dataset.id = product.id;

                // El campo de precio est√° PERMANENTEMENTE deshabilitado y solo muestra el valor
                const isPriceDisabled = true; 

                itemDiv.innerHTML = `
                    <span class="font-medium truncate">${product.name}</span>
                    <span class="text-center text-sm text-gray-600">${product.quantity} ${product.unit}</span>
                    <input type="text" 
                        class="final-price-input text-sm text-gray-800" 
                        value="${parseFloat(product.finalPrice || 0).toFixed(2)}"
                        data-id="${product.id}" 
                        disabled />
                    <input type="checkbox" 
                        class="w-5 h-5 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500 mx-auto"
                        ${product.checked ? 'checked' : ''} data-id="${product.id}" 
                        ${isClosed ? 'disabled' : ''} /> <!-- Checkbox deshabilitado si est√° cerrada -->
                `;

                $shoppingListContainer.appendChild(itemDiv);
            });
        }

        // Handler para actualizar el estado del producto (solo checked)
        $shoppingListContainer.addEventListener('change', (e) => {
            const target = e.target;
            const id = target.dataset.id;
            const quincenaData = monthlyLists[currentMonthKey][currentQuincena];

            if (quincenaData.isClosed) return; // No permitir cambios si est√° cerrado

            const list = quincenaData.items;
            const product = list.find(p => p.id === id);

            if (product) {
                // Solo manejar el cambio del checkbox
                if (target.type === 'checkbox') {
                    product.checked = target.checked;
                    
                    // Al marcar/desmarcar, no se modifica el precio final (finalPrice)
                    // Se mantiene el valor actual (que es el initialPrice heredado o el precio cerrado anterior).

                    // Actualizar clase visualmente
                    target.closest('.grid-list-item').classList.toggle('checked', target.checked);
                    
                    // Forzar re-renderizado solo de la lista para actualizar clases, aunque no es estrictamente necesario
                    // renderShoppingList(); 

                } 
                // NO hay l√≥gica para target.type === 'number'

                saveMonthlyList();
            }
        });


        function renderCatalog() {
            $catalogList.innerHTML = '';
            productCatalog.forEach(p => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-white p-3 border border-gray-200 rounded-lg shadow-sm';
                itemDiv.innerHTML = `
                    <div class="flex-1 mr-4">
                        <p class="font-semibold text-gray-800">${p.name}</p>
                        <p class="text-sm text-gray-500">${p.unitPrice} C$ / ${p.unit}</p>
                    </div>
                    <div class="space-x-2">
                        <button data-id="${p.id}" class="btn-edit-catalog bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-1 rounded hover:bg-yellow-200 transition">Editar</button>
                        <button data-id="${p.id}" class="btn-delete-catalog bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded hover:bg-red-200 transition">Eliminar</button>
                    </div>
                `;
                $catalogList.appendChild(itemDiv);
            });
        }

        // --- Cat√°logo CRUD Handlers ---

        document.getElementById('btn-open-catalog').addEventListener('click', () => {
            $catalogModal.classList.remove('hidden');
            $catalogModal.classList.add('flex');
            clearCatalogForm();
            renderCatalog();
        });

        document.getElementById('btn-close-catalog').addEventListener('click', () => {
            $catalogModal.classList.add('hidden');
            $catalogModal.classList.remove('flex');
            clearCatalogForm();
        });

        function clearCatalogForm() {
            document.getElementById('catalog-product-id').value = '';
            document.getElementById('catalog-product-name').value = '';
            document.getElementById('catalog-product-price').value = '';
            document.getElementById('catalog-product-unit').value = '';
            document.getElementById('btn-save-catalog-product').textContent = 'Guardar Producto';
        }

        document.getElementById('btn-clear-catalog-form').addEventListener('click', clearCatalogForm);

        document.getElementById('btn-save-catalog-product').addEventListener('click', () => {
            const id = document.getElementById('catalog-product-id').value;
            const name = document.getElementById('catalog-product-name').value.trim();
            const price = parseFloat(document.getElementById('catalog-product-price').value);
            const unit = document.getElementById('catalog-product-unit').value.trim();

            if (!name || isNaN(price) || price < 0 || !unit) {
                showCustomAlert('Por favor, complete todos los campos de forma v√°lida.', 'warning');
                return;
            }

            const existingIndex = productCatalog.findIndex(p => p.id === id);

            if (existingIndex !== -1) {
                // Editar
                productCatalog[existingIndex].name = name;
                productCatalog[existingIndex].unitPrice = price.toFixed(2);
                productCatalog[existingIndex].unit = unit;
                showCustomAlert(`Producto "${name}" actualizado.`, 'success');
            } else {
                // Agregar
                if (productCatalog.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                    showCustomAlert('Este producto ya existe en el cat√°logo.', 'error');
                    return;
                }
                productCatalog.push({
                    id: crypto.randomUUID(),
                    name: name,
                    unitPrice: price.toFixed(2),
                    unit: unit,
                    initialQuantity: 1
                });
                showCustomAlert(`Producto "${name}" agregado.`, 'success');
            }

            saveCatalog();
            clearCatalogForm();
            renderCatalog();
        });

        $catalogList.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            const product = productCatalog.find(p => p.id === id);
            if (!product) return;

            if (e.target.classList.contains('btn-edit-catalog')) {
                // Rellenar formulario para editar
                document.getElementById('catalog-product-id').value = product.id;
                document.getElementById('catalog-product-name').value = product.name;
                document.getElementById('catalog-product-price').value = product.unitPrice;
                document.getElementById('catalog-product-unit').value = product.unit;
                document.getElementById('btn-save-catalog-product').textContent = 'Actualizar Producto';
            } else if (e.target.classList.contains('btn-delete-catalog')) {
                // Usamos un modal de confirmaci√≥n personalizado si tuvi√©ramos m√°s tiempo, pero por ahora usamos confirm()
                if (confirm(`¬øEliminar el producto "${product.name}" del cat√°logo?`)) {
                    productCatalog = productCatalog.filter(p => p.id !== id);
                    saveCatalog();
                    renderCatalog();
                    showCustomAlert(`Producto "${product.name}" eliminado del cat√°logo.`, 'success');
                }
            }
        });

        // --- L√≥gica de Reportes ---

        function renderTotalCost() {
            if (!currentMonthKey || !monthlyLists[currentMonthKey]) {
                $totalCostDisplay.textContent = '0.00 C$';
                $costComparison.textContent = 'Seleccione o genere una lista.';
                return;
            }

            const currentListData = monthlyLists[currentMonthKey];
            const currentTotal = parseFloat(currentListData.totalMonthlyCost) || 0;
            $totalCostDisplay.textContent = `${currentTotal.toFixed(2)} C$`;

            // Comparaci√≥n con el mes anterior
            const allKeys = Object.keys(monthlyLists).sort();
            const currentIndex = allKeys.indexOf(currentMonthKey);

            if (currentIndex > 0) {
                const prevMonthKey = allKeys[currentIndex - 1];
                const prevTotal = parseFloat(monthlyLists[prevMonthKey].totalMonthlyCost) || 0;

                const diff = currentTotal - prevTotal;
                const percentDiff = prevTotal === 0 ? 0 : (diff / prevTotal) * 100;
                
                let comparisonText = '';
                if (diff > 0) {
                    comparisonText = `‚ñ≤ Subi√≥ ${diff.toFixed(2)} C$ (${percentDiff.toFixed(1)}%) respecto a ${monthlyLists[prevMonthKey].month}.`;
                    $costComparison.className = 'text-sm mt-2 text-red-600 font-semibold';
                } else if (diff < 0) {
                    comparisonText = `‚ñº Baj√≥ ${Math.abs(diff).toFixed(2)} C$ (${Math.abs(percentDiff).toFixed(1)}%) respecto a ${monthlyLists[prevMonthKey].month}.`;
                    $costComparison.className = 'text-sm mt-2 text-green-600 font-semibold';
                } else {
                    comparisonText = `‚Ä¢ El costo es id√©ntico al de ${monthlyLists[prevMonthKey].month}.`;
                    $costComparison.className = 'text-sm mt-2 text-gray-600';
                }
                $costComparison.textContent = comparisonText;
            } else {
                $costComparison.textContent = 'No hay datos de meses anteriores para comparar.';
                $costComparison.className = 'text-sm mt-2 text-gray-600';
            }
        }

        function renderPriceChangeReport() {
            $priceChangeReport.innerHTML = '';

            if (!currentMonthKey || !monthlyLists[currentMonthKey]) {
                $priceChangeReport.innerHTML = '<p class="text-gray-500">Seleccione o genere una lista.</p>';
                return;
            }

            const allKeys = Object.keys(monthlyLists).sort();
            const currentIndex = allKeys.indexOf(currentMonthKey);
            
            if (currentIndex === 0) {
                $priceChangeReport.innerHTML = '<p class="text-gray-500">No hay datos de meses anteriores para comparar.</p>';
                return;
            }

            const prevMonthKey = allKeys[currentIndex - 1];
            // Comparar precios iniciales de la quincena 1 (precio base)
            const currentList1 = monthlyLists[currentMonthKey].quincena1.items;
            const prevList1 = monthlyLists[prevMonthKey].quincena1.items;

            const reportItems = [];

            currentList1.forEach(currentProd => {
                const prevProd = prevList1.find(p => p.name === currentProd.name);

                if (prevProd) {
                    const currentPrice = parseFloat(currentProd.initialPrice);
                    const prevPrice = parseFloat(prevProd.initialPrice);
                    const diff = currentPrice - prevPrice;

                    if (Math.abs(diff) > 0.01) {
                        const icon = diff > 0 ? '‚ñ≤' : '‚ñº';
                        const color = diff > 0 ? 'text-red-600' : 'text-green-600';
                        const text = `${icon} ${currentProd.name}: ${Math.abs(diff).toFixed(2)} C$`;

                        reportItems.push(`<p class="${color} font-medium">${text}</p>`);
                    }
                }
            });

            if (reportItems.length > 0) {
                $priceChangeReport.innerHTML = reportItems.join('');
            } else {
                $priceChangeReport.innerHTML = '<p class="text-gray-600">No se detectaron cambios de precio en los productos comunes.</p>';
            }
        }

        // --- L√≥gica de Eventos de la App ---

        $monthSelector.addEventListener('change', (e) => {
            currentMonthKey = e.target.value;
            renderShoppingList();
            renderTotalCost();
            renderPriceChangeReport();
        });

        $quincenaSelector.addEventListener('change', (e) => {
            currentQuincena = e.target.value;
            renderShoppingList();
        });
        
        // Generar la lista inicial (Nov 2025)
        $btnInitialList.addEventListener('click', () => {
            // Generar lista para Noviembre de 2025 (Mes: 10, A√±o: 2025)
            const initialDate = new Date(2025, 10, 1);
            generateInitialList(initialDate);
        });

        // Generar el pr√≥ximo mes
        $btnGenerateNextMonth.addEventListener('click', () => {
            if (!currentMonthKey) {
                showCustomAlert('Primero debe haber una lista de compra inicial.', 'warning');
                return;
            }
            
            // Requerimiento: Solo generar si Quincena 2 est√° cerrada
            const currentMonthData = monthlyLists[currentMonthKey];
            if (!currentMonthData.quincena2.isClosed) {
                 showCustomAlert('Debe cerrar la Quincena 2 del mes actual antes de generar el pr√≥ximo mes.', 'error');
                 return;
            }

            // La lista inicial del nuevo mes se basa en la √∫ltima quincena (quincena2) del mes actual
            const baseList = currentMonthData.quincena2.items;

            // La fecha del mes siguiente se calcula sumando 1 al mes actual (base 0)
            const currentYear = parseInt(currentMonthKey.split('-')[0]);
            const currentMonth = parseInt(currentMonthKey.split('-')[1]); // 1-12
            const nextDate = new Date(currentYear, currentMonth, 1); // El mes siguiente (currentMonth es 1-12, js espera 0-11, pero el constructor maneja el desbordamiento)
            
            generateInitialList(nextDate, baseList);
        });

        $btnDeleteMonth.addEventListener('click', deleteCurrentMonthList);
        
        $btnCloseQuincena.addEventListener('click', closeQuincenaList);


        // --- L√≥gica de Carga de CSV ---

        $csvFileInput.addEventListener('change', () => {
            if ($csvFileInput.files.length > 0) {
                $btnUploadCsv.disabled = false;
            } else {
                $btnUploadCsv.disabled = true;
            }
        });

        $btnUploadCsv.addEventListener('click', () => {
            const file = $csvFileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                processCsvData(text);
            };
            reader.readAsText(file);
        });

        function processCsvData(csvText) {
            const lines = csvText.trim().split('\n');
            const newProducts = [];
            let addedCount = 0;
            let updatedCount = 0;
            let skippedDuplicates = 0;
            
            // Usamos un Set para detectar duplicados dentro del archivo CSV
            const csvNames = new Set();
            let hasInternalDuplicates = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // Asumimos formato: Nombre,Precio Base,Unidad
                const parts = line.split(',');
                if (parts.length < 3) continue;

                const name = parts[0].trim();
                const price = parseFloat(parts[1].trim());
                const unit = parts[2].trim();

                if (csvNames.has(name.toLowerCase())) {
                    hasInternalDuplicates = true;
                    skippedDuplicates++;
                    continue; // Saltar duplicado interno
                }
                csvNames.add(name.toLowerCase());

                if (name && !isNaN(price) && price >= 0 && unit) {
                    const existingProduct = productCatalog.find(p => p.name.toLowerCase() === name.toLowerCase());

                    if (existingProduct) {
                        // Actualizar si existe
                        existingProduct.unitPrice = price.toFixed(2);
                        existingProduct.unit = unit;
                        updatedCount++;
                    } else {
                        // Agregar si es nuevo
                        newProducts.push({
                            id: crypto.randomUUID(),
                            name: name,
                            unitPrice: price.toFixed(2),
                            unit: unit,
                            initialQuantity: 1
                        });
                        addedCount++;
                    }
                }
            }

            if (hasInternalDuplicates) {
                $csvFeedback.innerHTML = `<p class="text-red-500 font-semibold">‚ö† Advertencia: Se encontraron duplicados dentro del archivo CSV (${skippedDuplicates} l√≠neas omitidas).</p>`;
            }

            if (newProducts.length > 0) {
                productCatalog.push(...newProducts);
            }
            
            if (addedCount > 0 || updatedCount > 0) {
                saveCatalog();
                renderCatalog();
                showCustomAlert(`Carga CSV completa: ${addedCount} agregados, ${updatedCount} actualizados.`, 'success');
            } else if (!hasInternalDuplicates) {
                showCustomAlert('No se encontraron productos nuevos o v√°lidos para agregar.', 'warning');
            }
            
            // Limpiar input y bot√≥n
            $csvFileInput.value = '';
            $btnUploadCsv.disabled = true;
        }


        // --- Inicializaci√≥n de la Aplicaci√≥n y Autenticaci√≥n ---

        async function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                $authStatus.textContent = 'Conectando...';

                // Autenticaci√≥n
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user) {
                        userId = user.uid;
                        $authStatus.textContent = 'Sesi√≥n Activa';
                        $userIdDisplay.textContent = `ID Usuario: ${userId}`;
                        
                        // Una vez autenticado, iniciar los listeners de datos
                        setupCatalogListener();
                        setupMonthlyListsListener();
                    } else {
                        userId = null;
                        $authStatus.textContent = 'Sin Sesi√≥n';
                        $userIdDisplay.textContent = 'ID: Desconectado';
                        // Limpiar UI si no hay usuario
                        $shoppingListContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Inicie sesi√≥n para ver sus listas.</p>';
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showCustomAlert(`Error de inicializaci√≥n de Firebase: ${error.message}`, 'error');
                $authStatus.textContent = 'Error de Conexi√≥n';
            }
        }

        initApp();

    </script>
</body>
</html>