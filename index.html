<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Super PALI - Control de Compras</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .checkbox-wrapper input:checked + div {
            background-color: #10B981;
            border-color: #10B981;
        }
        .checkbox-wrapper input:checked + div svg {
            display: block;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .closed-list-overlay {
            background-image: repeating-linear-gradient(45deg, #f3f4f6 25%, transparent 25%, transparent 75%, #f3f4f6 75%, #f3f4f6), repeating-linear-gradient(45deg, #f3f4f6 25%, #f9fafb 25%, #f9fafb 75%, #f3f4f6 75%, #f3f4f6);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mb-4"></div>
        <p class="text-gray-600 font-medium">Procesando...</p>
    </div>

    <!-- MESSAGE/CONFIRM MODAL -->
    <div id="msgModal" class="fixed inset-0 bg-black bg-opacity-60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden transform transition-all scale-100">
            <div id="msgHeader" class="bg-gray-800 px-6 py-4 flex justify-between items-center">
                <h3 id="msgTitle" class="text-white font-bold text-lg">Mensaje</h3>
                <button onclick="app.closeMsgModal()" class="text-white hover:text-gray-300"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6">
                <p id="msgText" class="text-gray-700 mb-6 text-base leading-relaxed">Contenido...</p>
                
                <div id="msgBtnsAlert" class="hidden">
                    <button onclick="app.closeMsgModal()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-lg hover:bg-gray-900 transition shadow-md">
                        Entendido
                    </button>
                </div>

                <div id="msgBtnsConfirm" class="hidden flex gap-3">
                    <button onclick="app.closeMsgModal()" class="flex-1 bg-gray-200 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-300 transition">
                        Cancelar
                    </button>
                    <button id="msgConfirmBtn" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition shadow-md">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="authScreen" class="fixed inset-0 bg-gray-100 z-40 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
            <div class="mb-6 text-red-600">
                <i class="fa-solid fa-cart-shopping text-5xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Mi Super PALI</h1>
            <p class="text-gray-500 mb-8">Controla tus gastos quincenales y tu inventario.</p>
            
            <button id="loginBtn" class="w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition flex items-center justify-center gap-2 shadow-lg">
                <i class="fa-solid fa-arrow-right-to-bracket"></i> Entrar / Registrarse (Anónimo)
            </button>
            <p class="mt-4 text-xs text-gray-400">Nota: En producción, configura Google Auth.</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appContainer" class="flex-1 flex flex-col hidden h-full">
        
        <!-- NAVBAR -->
        <nav class="bg-red-600 text-white shadow-md shrink-0 z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-basket-shopping text-2xl"></i>
                        <span class="font-bold text-xl tracking-tight">Mi Super PALI</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="userEmailDisplay" class="text-sm hidden md:block opacity-90">Usuario</span>
                        <button id="logoutBtn" class="text-white hover:text-red-200 transition">
                            <i class="fa-solid fa-right-from-bracket text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- TABS -->
        <div class="bg-white border-b border-gray-200 shrink-0">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex gap-6 overflow-x-auto">
                <button onclick="app.switchTab('lists')" class="tab-btn active-tab py-4 px-2 text-sm font-medium border-b-2 border-red-600 text-red-600">
                    <i class="fa-solid fa-list-check mr-2"></i> Listas de Compra
                </button>
                <button onclick="app.switchTab('catalog')" class="tab-btn py-4 px-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fa-solid fa-book-open mr-2"></i> Catálogo
                </button>
                <button onclick="app.switchTab('reports')" class="tab-btn py-4 px-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fa-solid fa-chart-line mr-2"></i> Reportes
                </button>
            </div>
        </div>

        <!-- CONTENT AREA -->
        <main class="flex-1 overflow-hidden relative bg-gray-50">
            
            <!-- VIEW: SHOPPING LISTS -->
            <div id="view-lists" class="view-section h-full flex flex-col max-w-7xl mx-auto w-full">
                <!-- Toolbar -->
                <div class="p-4 bg-white border-b flex flex-col sm:flex-row justify-between items-center gap-4 shrink-0 shadow-sm">
                    <div class="flex items-center gap-3 w-full sm:w-auto">
                        <select id="listSelector" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block p-2.5 w-full sm:w-64">
                            <option value="">Cargando listas...</option>
                        </select>
                        <button onclick="app.deleteCurrentList()" class="text-gray-400 hover:text-red-600 p-2 hover:bg-red-50 rounded-full transition" title="Borrar esta lista">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="flex gap-2 w-full sm:w-auto items-center justify-end">
                        <!-- Botón Finalizar Lista -->
                        <button id="btnFinalizeList" onclick="app.finalizeList()" class="hidden bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg text-sm shadow transition items-center gap-2">
                            <i class="fa-solid fa-save"></i> <span class="hidden sm:inline">Finalizar Lista</span>
                        </button>
                        
                        <!-- Indicador Cerrado -->
                        <div id="badgeClosedList" class="hidden bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow flex items-center gap-2">
                            <i class="fa-solid fa-lock"></i> Cerrada
                        </div>

                        <button onclick="app.openCreateListModal()" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg text-sm shadow transition flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">Nueva</span>
                        </button>
                    </div>
                </div>

                <!-- Stats Bar -->
                <div id="listStats" class="bg-yellow-50 px-4 py-2 text-sm text-yellow-800 flex justify-between items-center shrink-0 border-b border-yellow-100 hidden">
                    <span><i class="fa-solid fa-coins mr-1"></i> Total Estimado: <span class="font-bold" id="statTotal">C$ 0</span></span>
                    <span><i class="fa-solid fa-cart-arrow-down mr-1"></i> Comprado: <span class="font-bold text-green-700" id="statBought">C$ 0</span></span>
                </div>

                <!-- Grid Header -->
                <div class="grid grid-cols-12 gap-2 px-4 py-2 bg-gray-100 text-xs font-semibold text-gray-500 uppercase tracking-wider shrink-0 border-b">
                    <div class="col-span-1 text-center">Check</div>
                    <div class="col-span-5 sm:col-span-6">Producto</div>
                    <div class="col-span-2 text-center">Cant.</div>
                    <div class="col-span-2 text-right">Precio</div>
                    <div class="col-span-2 sm:col-span-1 text-right">Total</div>
                </div>

                <!-- Scrollable List -->
                <div id="shoppingListContainer" class="flex-1 overflow-y-auto p-2 space-y-2 pb-20 relative">
                    <div class="text-center py-20 text-gray-400">
                        <i class="fa-solid fa-basket-shopping text-4xl mb-3 opacity-30"></i>
                        <p>Selecciona una lista o crea una nueva.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: CATALOG -->
            <div id="view-catalog" class="view-section hidden h-full flex flex-col max-w-7xl mx-auto w-full">
                <div class="p-4 bg-white border-b flex flex-wrap justify-between items-center gap-4 shrink-0">
                    <h2 class="text-lg font-bold text-gray-800">Catálogo de Productos</h2>
                    <div class="flex gap-2">
                        <!-- BOTÓN EXPORTAR NUEVO -->
                        <button onclick="app.exportCatalog()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition shadow flex items-center gap-2">
                            <i class="fa-solid fa-download"></i> <span class="hidden sm:inline">Exportar CSV</span>
                        </button>

                        <button onclick="document.getElementById('csvInput').click()" class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition shadow">
                            <i class="fa-solid fa-file-excel mr-2"></i> Importar CSV
                        </button>
                        <input type="file" id="csvInput" accept=".csv,.txt" class="hidden" onchange="app.handleFileUpload(this)">
                        
                        <button onclick="app.openProductModal()" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium py-2 px-4 rounded-lg transition shadow">
                            <i class="fa-solid fa-plus mr-2"></i> Nuevo
                        </button>
                        
                        <button onclick="app.clearCatalog()" title="Borrar todo el catálogo" class="bg-gray-200 hover:bg-red-100 hover:text-red-600 text-gray-600 text-sm font-medium py-2 px-4 rounded-lg transition">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Catalog Header -->
                <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-gray-50 text-xs font-semibold text-gray-500 uppercase border-b shrink-0">
                    <div class="col-span-6">Nombre</div>
                    <div class="col-span-2 text-right">Precio (C$)</div>
                    <div class="col-span-2 text-center">Cant. Default</div>
                    <div class="col-span-2 text-right">Acciones</div>
                </div>

                <!-- Catalog List -->
                <div id="catalogListContainer" class="flex-1 overflow-y-auto p-4 space-y-1 bg-white">
                    <!-- Products injected here -->
                </div>
            </div>

            <!-- VIEW: REPORTS -->
            <div id="view-reports" class="view-section hidden h-full flex flex-col max-w-7xl mx-auto w-full overflow-y-auto p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Reporte de Gastos Mensuales</h2>
                
                <div id="reportsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Report Cards Injected Here -->
                </div>

                <div class="mt-8 p-6 bg-white rounded-xl shadow border border-gray-100">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Comparativa de Precios</h3>
                    <p class="text-sm text-gray-500 mb-4">Productos que han cambiado de precio respecto al catálogo actual.</p>
                    <div id="priceAlerts" class="space-y-2">
                        <!-- Alerts -->
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL: NEW LIST -->
    <div id="newListModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden">
            <div class="bg-red-600 px-6 py-4 flex justify-between items-center">
                <h3 class="text-white font-bold">Crear Lista de Compra</h3>
                <button onclick="app.closeModal('newListModal')" class="text-white hover:text-red-200"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mes</label>
                    <input type="month" id="newListMonth" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Quincena</label>
                    <select id="newListQuincena" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500">
                        <option value="1">Quincena 1</option>
                        <option value="2">Quincena 2</option>
                    </select>
                </div>
                <div class="bg-blue-50 p-3 rounded-lg text-xs text-blue-700">
                    <i class="fa-solid fa-info-circle mr-1"></i> 
                    Se usarán los precios y productos actuales del catálogo.
                </div>
                <button onclick="app.createNewList()" class="w-full bg-red-600 text-white font-bold py-2 rounded-lg hover:bg-red-700 transition">
                    Generar Lista
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: PRODUCT CRUD -->
    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden">
            <div class="bg-gray-800 px-6 py-4 flex justify-between items-center">
                <h3 class="text-white font-bold" id="modalProductTitle">Producto</h3>
                <button onclick="app.closeModal('productModal')" class="text-white hover:text-gray-300"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="prodId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto</label>
                    <input type="text" id="prodName" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 uppercase">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Precio (C$)</label>
                        <input type="number" step="0.01" id="prodPrice" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
                        <input type="number" step="1" id="prodQty" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
                <button onclick="app.saveProduct()" class="w-full bg-gray-800 text-white font-bold py-2 rounded-lg hover:bg-gray-900 transition">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc, writeBatch, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // 1. FIREBASE CONFIGURATION
        // ==========================================
        
        const firebaseConfig = {
        apiKey: "AIzaSyBYpzpEwnHLKTBJrPessNqwgGF9-2S1BXo",
        authDomain: "app-listacompraquincenal.firebaseapp.com",
        projectId: "app-listacompraquincenal",
        storageBucket: "app-listacompraquincenal.firebasestorage.app",
        messagingSenderId: "178599255890",
        appId: "1:178599255890:web:1f7934ab9c5ba6019be48b",
        measurementId: "G-CVCNG2DKQV"
        };

        // DATOS EXACTOS DEL ARCHIVO ADJUNTO (Hoja2)
        const INITIAL_CSV_DATA = `Producto,Precio (C$),Cantidad
PAMPER TALLA M,278,2
ARROZ 80 20,337.47,1
PINILLO,50.5,2
AZUCAR,67.5,1
FOSFOROS,20.25,1
JALEA,28.5,1
CAFÉ,74,1
MOZTAZA,39.5,1
TANG,9.25,5
MAZECA,31,1
ACEITE,83,1
TOULLA HUMEDA,51.5,1
JABON TRASTE,28.5,1
ASISTIN,29.5,1
GALLETA SULI VAINILLA,37,1
POSTA CERDO,196.08,1
ACE SULI,110,1
YOGURT,52,2
LECHE,38,7
SAL,5.5,1
CUBITO MAGUI,13.5,2
LIZANO,12,3
SANIADOR,26.5,2
MARGARINA,14,1
EMPANIZADOR,51,1
PASTE TRASTE,17.5,1
CLORO,49.5,1
BAYGON,184,1
GEL,54,1
POLLO,407.96,1
BISTEC,330.4,1
CARNE MOLIDA,128.7,1
BANANO,19.25,1
GATO TRAMPA,56,1`;

        // Initialize Firebase
        let app, auth, db;
        let userId = null;
        let currentListId = null;
        let currentListStatus = 'active'; 
        let unsubscribeList = null;
        let allProducts = []; 

        try {
            const configToUse = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default';
            
            app = initializeApp(configToUse);
            auth = getAuth(app);
            db = getFirestore(app);

            console.log("Firebase initialized.");
        } catch (e) {
            console.error("Firebase init error:", e);
        }

        // ==========================================
        // 2. APP LOGIC CLASS
        // ==========================================

        class SupermarketApp {
            constructor() {
                this.bindEvents();
            }

            bindEvents() {
                document.getElementById('loginBtn').addEventListener('click', () => this.login());
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                
                const today = new Date();
                const monthStr = today.toISOString().slice(0, 7);
                document.getElementById('newListMonth').value = monthStr;
            }
            
            escapeStr(str) {
                return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            }

            // --- CUSTOM UI HELPERS ---
            showMessage(title, text) {
                document.getElementById('msgTitle').innerText = title;
                document.getElementById('msgText').innerText = text;
                document.getElementById('msgBtnsAlert').classList.remove('hidden');
                document.getElementById('msgBtnsConfirm').classList.add('hidden');
                document.getElementById('msgHeader').className = "bg-gray-800 px-6 py-4 flex justify-between items-center";
                document.getElementById('msgModal').classList.remove('hidden');
            }

            showConfirm(title, text, onConfirmCallback, isDestructive = false) {
                document.getElementById('msgTitle').innerText = title;
                document.getElementById('msgText').innerText = text;
                document.getElementById('msgBtnsAlert').classList.add('hidden');
                document.getElementById('msgBtnsConfirm').classList.remove('hidden');
                
                const header = document.getElementById('msgHeader');
                header.className = isDestructive 
                    ? "bg-red-600 px-6 py-4 flex justify-between items-center" 
                    : "bg-blue-600 px-6 py-4 flex justify-between items-center";

                const confirmBtn = document.getElementById('msgConfirmBtn');
                const newBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
                
                newBtn.onclick = () => {
                    this.closeMsgModal();
                    onConfirmCallback();
                };
                
                document.getElementById('msgModal').classList.remove('hidden');
            }

            closeMsgModal() {
                document.getElementById('msgModal').classList.add('hidden');
            }

            // --- Auth ---
            async login() {
                this.showLoading(true);
                try {
                    if (typeof __initial_auth_token !== 'undefined') {
                         await signInAnonymously(auth);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error(error);
                    this.showMessage("Error de Acceso", "No se pudo iniciar sesión: " + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async logout() {
                await signOut(auth);
                window.location.reload();
            }

            // --- Navigation ---
            switchTab(tabName) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${tabName}`).classList.remove('hidden');
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active-tab', 'text-red-600', 'border-red-600');
                    btn.classList.add('text-gray-500', 'border-transparent');
                });
                
                const activeBtn = document.querySelector(`button[onclick="app.switchTab('${tabName}')"]`);
                if(activeBtn) {
                    activeBtn.classList.add('active-tab', 'text-red-600', 'border-red-600');
                    activeBtn.classList.remove('text-gray-500', 'border-transparent');
                }

                if(tabName === 'catalog') this.loadCatalog();
                if(tabName === 'reports') this.loadReports();
            }

            // --- Catalog Management ---
            async loadCatalog() {
                if(!userId) return;
                this.showLoading(true);
                const q = query(collection(db, `artifacts/${this.getAppId()}/users/${userId}/products`), orderBy("name"));
                
                try {
                    const querySnapshot = await getDocs(q);
                    allProducts = [];
                    const container = document.getElementById('catalogListContainer');
                    container.innerHTML = '';

                    if (querySnapshot.empty) {
                        container.innerHTML = `
                            <div class="flex flex-col items-center justify-center py-12 text-center">
                                <i class="fa-solid fa-box-open text-6xl text-gray-200 mb-4"></i>
                                <p class="text-gray-500 mb-4">Tu catálogo está vacío.</p>
                                <button onclick="app.loadDefaultData()" class="bg-blue-100 text-blue-700 hover:bg-blue-200 px-4 py-2 rounded-lg font-medium text-sm transition">
                                    <i class="fa-solid fa-upload mr-2"></i> Cargar Sugeridos
                                </button>
                            </div>
                        `;
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const p = doc.data();
                        allProducts.push({id: doc.id, ...p});
                        
                        const el = document.createElement('div');
                        el.className = "grid grid-cols-12 gap-4 px-6 py-3 border-b hover:bg-gray-50 items-center transition";
                        el.innerHTML = `
                            <div class="col-span-6 font-medium text-gray-800 truncate">${p.name}</div>
                            <div class="col-span-2 text-right font-mono text-gray-600">C$ ${p.price}</div>
                            <div class="col-span-2 text-center text-gray-500 bg-gray-100 rounded py-1 text-xs mx-auto w-12">${p.quantity}</div>
                            <div class="col-span-2 text-right flex justify-end gap-2">
                                <button onclick="app.openProductModal('${doc.id}')" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="app.deleteProduct('${doc.id}')" class="text-red-500 hover:bg-red-50 p-1 rounded"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        `;
                        container.appendChild(el);
                    });
                } catch (e) {
                    console.error(e);
                } finally {
                    this.showLoading(false);
                }
            }

            // FUNCION EXPORTAR NUEVA
            exportCatalog() {
                if (!allProducts || allProducts.length === 0) return this.showMessage("Error", "No hay datos para exportar.");
                
                let csvContent = "Producto,Precio (C$),Cantidad\n";
                
                allProducts.forEach(p => {
                    // Limpiar nombres con comas
                    const name = p.name.includes(',') ? `"${p.name}"` : p.name; 
                    csvContent += `${name},${p.price},${p.quantity}\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "catalogo_productos.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            async loadDefaultData() {
                await this.parseAndUploadCSV(INITIAL_CSV_DATA);
            }

            async parseAndUploadCSV(csvText) {
                this.showLoading(true);
                const lines = csvText.trim().split(/\r?\n/);
                const batch = writeBatch(db);
                const productsRef = collection(db, `artifacts/${this.getAppId()}/users/${userId}/products`);
                
                let count = 0;
                const startIndex = lines[0].includes('Producto') ? 1 : 0;
                const existingSnap = await getDocs(productsRef);
                const existingNames = new Set();
                existingSnap.forEach(d => existingNames.add(d.data().name.toUpperCase()));

                for (let i = startIndex; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if(!line) continue;
                    const parts = line.split(','); 
                    if(parts.length < 2) continue;

                    const rawName = parts[0].trim().toUpperCase();
                    const name = rawName.replace(/["']/g, "");
                    const price = parseFloat(parts[1]) || 0;
                    const qty = parseFloat(parts[2]) || 1;

                    if (!existingNames.has(name)) {
                        const newDoc = doc(productsRef);
                        batch.set(newDoc, { name, price, quantity: qty });
                        existingNames.add(name);
                        count++;
                    }
                }

                if (count > 0) {
                    await batch.commit();
                    this.showLoading(false);
                    this.showMessage("Importación Exitosa", `Se agregaron ${count} productos al catálogo.`);
                    this.loadCatalog();
                } else {
                    this.showLoading(false);
                    // Verificación más flexible
                    if(count === 0 && existingNames.size > 0 && csvText === INITIAL_CSV_DATA) {
                         this.showMessage("Aviso", "Ya tienes todos los productos sugeridos cargados.");
                    } else if (count === 0 && csvText !== INITIAL_CSV_DATA) {
                         this.showMessage("Aviso", "No se encontraron productos nuevos en el archivo.");
                    }
                    else this.loadCatalog();
                }
            }

            handleFileUpload(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.parseAndUploadCSV(e.target.result);
                    input.value = ''; 
                };
                reader.readAsText(file);
            }

            openProductModal(prodId = null) {
                const modal = document.getElementById('productModal');
                document.getElementById('prodId').value = prodId || '';
                document.getElementById('modalProductTitle').innerText = prodId ? 'Editar Producto' : 'Nuevo Producto';
                
                if (prodId) {
                    const p = allProducts.find(x => x.id === prodId);
                    document.getElementById('prodName').value = p.name;
                    document.getElementById('prodPrice').value = p.price;
                    document.getElementById('prodQty').value = p.quantity;
                } else {
                    document.getElementById('prodName').value = '';
                    document.getElementById('prodPrice').value = '';
                    document.getElementById('prodQty').value = '1';
                }
                modal.classList.remove('hidden');
            }

            async saveProduct() {
                const id = document.getElementById('prodId').value;
                const nameRaw = document.getElementById('prodName').value.trim().toUpperCase();
                const name = nameRaw.replace(/["']/g, ""); 
                const price = parseFloat(document.getElementById('prodPrice').value) || 0;
                const quantity = parseFloat(document.getElementById('prodQty').value) || 1;

                if (!name) return this.showMessage("Faltan Datos", "El nombre es requerido");

                const colRef = collection(db, `artifacts/${this.getAppId()}/users/${userId}/products`);

                try {
                    if (id) {
                        await setDoc(doc(colRef, id), { name, price, quantity }, { merge: true });
                    } else {
                        const q = query(colRef, where("name", "==", name));
                        const snap = await getDocs(q);
                        if (!snap.empty) return this.showMessage("Duplicado", "El producto ya existe");
                        await setDoc(doc(colRef), { name, price, quantity });
                    }
                    this.closeModal('productModal');
                    this.loadCatalog();
                } catch (e) {
                    console.error(e);
                    this.showMessage("Error", "Error al guardar: " + e.message);
                }
            }

            async deleteProduct(id) {
                if(!userId) return;
                this.showConfirm("Borrar Producto", "¿Estás seguro que quieres eliminar este producto del catálogo permanentemente?", async () => {
                    this.showLoading(true);
                    try {
                        await deleteDoc(doc(db, `artifacts/${this.getAppId()}/users/${userId}/products`, id));
                        await this.loadCatalog();
                    } catch (e) {
                        console.error("Error borrando:", e);
                        this.showMessage("Error", "No se pudo borrar: " + e.message);
                    } finally {
                        this.showLoading(false);
                    }
                }, true);
            }
            
            async clearCatalog() {
                if(!userId) return;
                this.showConfirm("PELIGRO: Vaciar Catálogo", "¿Estás seguro que quieres BORRAR TODO el catálogo? Esta acción no se puede deshacer.", async () => {
                     this.showLoading(true);
                     try {
                         const colRef = collection(db, `artifacts/${this.getAppId()}/users/${userId}/products`);
                         const snap = await getDocs(colRef);
                         
                         if(snap.empty) {
                             this.showLoading(false);
                             this.showMessage("Aviso", "El catálogo ya está vacío.");
                             return;
                         }

                         const batchSize = 400; 
                         const chunks = [];
                         let docs = snap.docs;

                         for (let i = 0; i < docs.length; i += batchSize) {
                             const chunk = docs.slice(i, i + batchSize);
                             const batch = writeBatch(db);
                             chunk.forEach(doc => batch.delete(doc.ref));
                             chunks.push(batch.commit());
                         }

                         await Promise.all(chunks);
                         
                         document.getElementById('catalogListContainer').innerHTML = '';
                         this.showMessage("Éxito", "El catálogo ha sido eliminado correctamente.");
                         await this.loadCatalog();
                     } catch (e) {
                         console.error("Error limpiando catálogo:", e);
                         this.showMessage("Error", "Error al limpiar: " + e.message);
                     } finally {
                         this.showLoading(false);
                     }
                 }, true);
            }

            // --- Shopping List Logic ---
            
            async fetchLists() {
                if (!userId) return;
                const selector = document.getElementById('listSelector');
                selector.innerHTML = '<option>Cargando...</option>';
                
                const q = query(collection(db, `artifacts/${this.getAppId()}/users/${userId}/shopping_lists`), orderBy("listId", "desc"));
                
                const snap = await getDocs(q);
                selector.innerHTML = '';
                
                if (snap.empty) {
                    selector.innerHTML = '<option value="">Sin listas (Crea una)</option>';
                    document.getElementById('shoppingListContainer').innerHTML = '<div class="text-center py-10 text-gray-400">Crea una lista nueva para comenzar</div>';
                    document.getElementById('listStats').classList.add('hidden');
                    document.getElementById('btnFinalizeList').classList.add('hidden');
                    return;
                }

                snap.forEach(d => {
                    const data = d.data();
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    const [year, month, q] = data.listId.split('-');
                    const dateObj = new Date(year, parseInt(month)-1);
                    const monthName = dateObj.toLocaleString('es-ES', { month: 'long' }).toUpperCase();
                    opt.text = `${monthName} ${year} - QUINCENA ${q.replace('Q','')}`;
                    if(d.id === currentListId) opt.selected = true;
                    selector.appendChild(opt);
                });

                selector.onchange = (e) => this.loadListDetail(e.target.value);
                
                if (!currentListId && snap.docs.length > 0) {
                    this.loadListDetail(snap.docs[0].id);
                }
            }

            openCreateListModal() {
                document.getElementById('newListModal').classList.remove('hidden');
            }

            async createNewList() {
                const monthVal = document.getElementById('newListMonth').value;
                const qVal = document.getElementById('newListQuincena').value;
                
                if (!monthVal) return this.showMessage("Faltan Datos", "Selecciona un mes");
                
                const listId = `${monthVal}-Q${qVal}`;
                
                const exists = await getDocs(query(collection(db, `artifacts/${this.getAppId()}/users/${userId}/shopping_lists`), where("listId", "==", listId)));
                
                if(!exists.empty) {
                    this.showConfirm("Lista Existente", "Esta lista ya existe. ¿Quieres sobrescribirla y reiniciar los precios/checks?", () => {
                        this._generateList(listId, monthVal, qVal);
                    }, true);
                } else {
                    this._generateList(listId, monthVal, qVal);
                }
            }

            async _generateList(listId, monthVal, qVal) {
                const listRef = doc(db, `artifacts/${this.getAppId()}/users/${userId}/shopping_lists`, listId);
                this.showLoading(true);
                try {
                    const catalogSnap = await getDocs(collection(db, `artifacts/${this.getAppId()}/users/${userId}/products`));
                    const items = [];
                    catalogSnap.forEach(d => {
                        const p = d.data();
                        items.push({
                            productId: d.id,
                            name: p.name,
                            price: p.price,
                            quantity: p.quantity,
                            checked: false
                        });
                    });

                    await setDoc(listRef, {
                        listId: listId,
                        month: monthVal,
                        quincena: parseInt(qVal),
                        createdAt: new Date().toISOString(),
                        items: items,
                        status: 'active' // Default status
                    });

                    this.closeModal('newListModal');
                    await this.fetchLists();
                    this.loadListDetail(listId);

                } catch(e) {
                    console.error(e);
                    this.showMessage("Error", "Error creando lista: " + e.message);
                } finally {
                    this.showLoading(false);
                }
            }

            loadListDetail(listId) {
                if (!listId) return;
                currentListId = listId;

                if (unsubscribeList) unsubscribeList();

                const docRef = doc(db, `artifacts/${this.getAppId()}/users/${userId}/shopping_lists`, listId);

                document.getElementById('shoppingListContainer').innerHTML = '<div class="p-4 text-center">Cargando items...</div>';
                document.getElementById('listStats').classList.remove('hidden');

                unsubscribeList = onSnapshot(docRef, (docSnap) => {
                    if (!docSnap.exists()) { this.fetchLists(); return; }
                    
                    const data = docSnap.data();
                    const items = data.items || [];
                    currentListStatus = data.status || 'active';

                    // Control de Interfaz según Estado
                    const btnFinalize = document.getElementById('btnFinalizeList');
                    const badgeClosed = document.getElementById('badgeClosedList');
                    
                    if(currentListStatus === 'closed') {
                        btnFinalize.classList.add('hidden');
                        badgeClosed.classList.remove('hidden');
                    } else {
                        btnFinalize.classList.remove('hidden');
                        badgeClosed.classList.add('hidden');
                    }
                    
                    const sortedItems = [...items].sort((a, b) => {
                        if (a.checked === b.checked) return a.name.localeCompare(b.name);
                        return a.checked ? 1 : -1;
                    });

                    const container = document.getElementById('shoppingListContainer');
                    container.innerHTML = '';
                    
                    let totalEst = 0;
                    let totalBought = 0;

                    sortedItems.forEach((item) => {
                        const lineTotal = item.price * item.quantity;
                        totalEst += lineTotal;
                        if (item.checked) totalBought += lineTotal;

                        const el = document.createElement('div');
                        // Estilo especial si está cerrada
                        const isClosed = currentListStatus === 'closed';
                        const bgClass = isClosed ? 'bg-gray-50 opacity-60' : (item.checked ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200');
                        
                        el.className = `grid grid-cols-12 gap-2 items-center p-3 rounded-lg shadow-sm border transition-all ${bgClass}`;
                        
                        const safeName = this.escapeStr(item.name);
                        // Deshabilitar checkbox si está cerrada
                        const disabledAttr = isClosed ? 'disabled' : '';

                        el.innerHTML = `
                            <div class="col-span-1 flex justify-center checkbox-wrapper relative w-6 h-6">
                                <input type="checkbox" class="absolute opacity-0 w-full h-full ${isClosed ? '' : 'cursor-pointer'} z-10" 
                                    ${item.checked ? 'checked' : ''} 
                                    ${disabledAttr}
                                    onchange="app.toggleItemByName('${listId}', '${safeName}', this.checked)">
                                <div class="w-6 h-6 border-2 border-gray-300 rounded flex items-center justify-center transition bg-white pointer-events-none">
                                    <i class="fa-solid fa-check text-white text-xs ${item.checked ? 'block' : 'hidden'}"></i>
                                </div>
                            </div>
                            <div class="col-span-5 sm:col-span-6 text-sm font-medium leading-tight ${item.checked ? 'line-through text-gray-400' : 'text-gray-800'}">
                                ${item.name}
                            </div>
                            <div class="col-span-2 text-center text-sm text-gray-600 bg-gray-100 rounded px-1">
                                ${item.quantity}
                            </div>
                            <div class="col-span-2 text-right text-sm font-mono text-gray-600">
                                ${item.price}
                            </div>
                            <div class="col-span-2 sm:col-span-1 text-right text-sm font-bold ${item.checked ? 'text-green-600' : 'text-gray-800'}">
                                ${lineTotal.toLocaleString()}
                            </div>
                        `;
                        container.appendChild(el);
                    });

                    document.getElementById('statTotal').innerText = 'C$ ' + totalEst.toLocaleString();
                    document.getElementById('statBought').innerText = 'C$ ' + totalBought.toLocaleString();
                });
            }

            async finalizeList() {
                if(!currentListId) return;
                this.showConfirm("Finalizar Lista", "¿Estás seguro que deseas cerrar esta lista? No podrás marcar ni desmarcar productos después.", async () => {
                    const docRef = doc(db, `artifacts/${this.getAppId()}/users/${userId}/shopping_lists`, currentListId);
                    try {
                        await setDoc(docRef, { status: 'closed' }, { merge: true });
                        this.showMessage("Lista Finalizada", "La lista ha sido cerrada y guardada para reportes.");
                    } catch (e) {
                        this.showMessage("Error", "No se pudo finalizar: " + e.message);
                    }
                });
            }

            async toggleItemByName(listId, productName, isChecked) {
                // Verificar si la lista está cerrada antes de intentar escribir
                if (currentListStatus === 'closed') {
                    this.showMessage("Lista Cerrada", "Esta lista ya fue finalizada. No se pueden hacer cambios.");
                    // Revertir visualmente el checkbox (opcional, pero la UI se repinta rápido con snapshot)
                    return;
                }

                const docRef = doc(db, `artifacts/${this.getAppId()}/users/${userId}/shopping_lists`, listId);
                
                const snap = await getDocs(query(collection(db, `artifacts/${this.getAppId()}/users/${userId}/shopping_lists`), where("listId", "==", listId)));
                let foundDoc = null;
                snap.forEach(d => foundDoc = d);
                
                if(foundDoc) {
                    const data = foundDoc.data();
                    if(data.status === 'closed') return; // Doble verificación

                    const newItems = data.items.map(i => {
                        if(i.name === productName) return { ...i, checked: isChecked };
                        return i;
                    });
                    
                    await setDoc(foundDoc.ref, { items: newItems }, { merge: true });
                }
            }

            async deleteCurrentList() {
                if(!currentListId) return;
                this.showConfirm("Borrar Lista", "¿Estás seguro que quieres eliminar esta lista? No podrás recuperarla.", async () => {
                    await deleteDoc(doc(db, `artifacts/${this.getAppId()}/users/${userId}/shopping_lists`, currentListId));
                    currentListId = null;
                    this.fetchLists();
                }, true);
            }

            // --- Reports ---
            async loadReports() {
                if(!userId) return;
                const container = document.getElementById('reportsContainer');
                container.innerHTML = '<p>Calculando...</p>';
                
                const q = query(collection(db, `artifacts/${this.getAppId()}/users/${userId}/shopping_lists`));
                const snap = await getDocs(q);
                
                const monthTotals = {};
                
                snap.forEach(d => {
                    const data = d.data();
                    const m = data.month;
                    if(!monthTotals[m]) monthTotals[m] = { total: 0, bought: 0, lists: 0 };
                    
                    data.items.forEach(item => {
                        const cost = item.price * item.quantity;
                        monthTotals[m].total += cost;
                        if(item.checked) monthTotals[m].bought += cost;
                    });
                    monthTotals[m].lists++;
                });
                
                container.innerHTML = '';
                const sortedMonths = Object.keys(monthTotals).sort();
                
                sortedMonths.forEach(m => {
                    const [year, month] = m.split('-');
                    const dateName = new Date(year, month-1).toLocaleString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
                    const d = monthTotals[m];
                    
                    const card = document.createElement('div');
                    card.className = "bg-white p-6 rounded-xl shadow border-t-4 border-red-600";
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">${dateName}</h3>
                                <p class="text-xs text-gray-500">${d.lists} Listas (Q1/Q2)</p>
                            </div>
                            <div class="bg-red-100 text-red-600 p-2 rounded-full">
                                <i class="fa-solid fa-calendar-check"></i>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Presupuesto:</span>
                                <span class="font-semibold">C$ ${d.total.toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Ejecutado:</span>
                                <span class="font-bold text-green-600">C$ ${d.bought.toLocaleString()}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                                <div class="bg-green-600 h-2.5 rounded-full" style="width: ${(d.bought/d.total*100) || 0}%"></div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            // --- Utils ---
            showLoading(show) {
                const el = document.getElementById('loadingOverlay');
                if(show) el.classList.remove('hidden');
                else el.classList.add('hidden');
            }
            
            closeModal(id) {
                document.getElementById(id).classList.add('hidden');
            }
            
            getAppId() {
                return typeof __app_id !== 'undefined' ? __app_id : 'default-app';
            }
        }

        // Initialize App Global
        window.app = new SupermarketApp();

        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                
                const display = user.email || "Usuario " + user.uid.substring(0,4);
                document.getElementById('userEmailDisplay').innerText = display;
                
                window.app.fetchLists();
            } else {
                userId = null;
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
            }
        });

    </script>
</body>
</html>